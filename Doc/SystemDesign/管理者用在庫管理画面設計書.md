# 管理者用在庫管理画面設計書

## 目次
- [1. 基本情報](#1-基本情報)
- [2. 画面概要](#2-画面概要)
- [3. UI要素一覧](#3-ui要素一覧)
- [4. 機能仕様](#4-機能仕様)
- [5. バリデーション](#5-バリデーション)
- [6. セキュリティ](#6-セキュリティ)
- [7. レイアウト](#7-レイアウト)
- [8. 使用技術](#8-使用技術)
- [9. データ仕様](#9-データ仕様)

---

## 1. 基本情報

| 項目 | 内容 |
|------|------|
| 画面ID | ADM-INV-001 |
| 画面名 | 管理者用在庫管理画面 |
| URL | /admin/inventory |
| アクセス権限 | 管理者のみ |
| 作成日 | 2026年2月4日 |
| 更新日 | 2026年2月4日 |

---

## 2. 画面概要

管理者が商品の在庫状況を総合的に管理するための画面です。一般ユーザー向け在庫管理画面の機能に加え、在庫の一括編集、CSV一括更新、詳細な在庫履歴の表示、在庫アラートの設定など、管理者専用の高度な機能を提供します。

### 主な機能
- 在庫状況の総合管理とリアルタイム表示
- 在庫の一括編集・一括更新機能
- CSV形式での一括インポート・エクスポート
- 在庫アラート閾値の設定
- 詳細な在庫変動履歴の表示
- 在庫レポートの生成
- 商品の検索・フィルタリング（高度）
- 個別商品の入庫・出庫管理

### 一般ユーザー画面との違い
- 在庫の一括編集が可能
- CSV一括インポート・エクスポート機能
- 在庫アラート閾値の変更権限
- 在庫変動履歴の詳細表示
- 論理削除された商品の表示・復元
- 在庫レポート機能

---

## 3. UI要素一覧

### 3.1 ナビゲーションバー（管理者用）

| No | 要素種別 | 項目名 | 入力形式 | 必須/任意 | 備考 |
|----|----------|--------|----------|-----------|------|
| 1 | ロゴ/リンク | システム名 | link | - | 「商品在庫管理システム」<br>/admin/menuへ遷移<br>管理者バッジ表示 |
| 2 | ナビゲーションリンク | 在庫管理 | link | - | /admin/inventoryへ遷移<br>アイコン：bi-clipboard-data<br>現在地：active状態 |
| 3 | ナビゲーションリンク | 商品管理 | link | - | /admin/productsへ遷移<br>アイコン：bi-box-seam |
| 4 | ナビゲーションリンク | ユーザー管理 | link | - | /admin/usersへ遷移<br>アイコン：bi-people |
| 5 | ナビゲーションリンク | メニュー | link | - | /admin/menuへ遷移<br>アイコン：bi-house |
| 6 | ボタン | ログアウト | submit | - | /logoutへPOST送信<br>アイコン：bi-box-arrow-right |

### 3.2 ページヘッダー

| No | 要素種別 | 項目名 | 入力形式 | 必須/任意 | 備考 |
|----|----------|--------|----------|-----------|------|
| 7 | 見出し | ページタイトル | - | - | 「在庫管理」<br>アイコン：bi-clipboard-data |
| 8 | ボタングループ | アクション | - | - | 右上に配置 |
| 9 | ボタン | CSV一括更新 | button | - | CSVインポート画面へ遷移<br>アイコン：bi-upload<br>スタイル：btn-success |
| 10 | ボタン | CSVエクスポート | button | - | 在庫データをCSV出力<br>アイコン：bi-download<br>スタイル：btn-outline-primary |
| 11 | ボタン | 在庫レポート | button | - | 在庫レポート画面へ遷移<br>アイコン：bi-graph-up<br>スタイル：btn-outline-info |

### 3.3 在庫不足アラート

| No | 要素種別 | 項目名 | 入力形式 | 必須/任意 | 備考 |
|----|----------|--------|----------|-----------|------|
| 12 | アラート | 在庫不足通知 | alert-warning | - | 在庫不足・在庫切れ商品数を表示<br>アイコン：bi-exclamation-triangle-fill<br>閾値設定リンク付き |
| 13 | リンク | 閾値設定 | link | - | アラート閾値設定モーダルを開く |

### 3.4 検索・フィルタリングパネル（拡張版）

| No | 要素種別 | 項目名 | 入力形式 | 必須/任意 | 備考 |
|----|----------|--------|----------|-----------|------|
| 14 | 入力欄 | 商品名・ID検索 | text | 任意 | プレースホルダー：「商品名またはIDを入力」<br>部分一致検索 |
| 15 | セレクトボックス | カテゴリフィルタ | select | 任意 | オプション：全て、Electronics、Clothing、Home Appliances |
| 16 | セレクトボックス | ステータスフィルタ | select | 任意 | オプション：全て、販売中(active)、販売停止(inactive)、削除済み(deleted) |
| 17 | セレクトボックス | 在庫状態フィルタ | select | 任意 | オプション：全て、在庫あり、在庫不足、在庫切れ |
| 18 | セレクトボックス | 並び順 | select | 任意 | オプション：商品名順、在庫数順（昇順）、在庫数順（降順）、更新日順<br>デフォルト：商品名順 |
| 19 | 入力欄（範囲） | 価格範囲 | number | 任意 | 最小価格〜最大価格<br>2つの入力欄 |
| 20 | 入力欄（範囲） | 在庫数範囲 | number | 任意 | 最小在庫数〜最大在庫数<br>2つの入力欄 |
| 21 | ボタン | 検索ボタン | submit | - | 検索実行<br>アイコン：bi-search<br>スタイル：btn-primary |
| 22 | ボタン | クリアボタン | reset | - | フォームリセット<br>アイコン：bi-x-circle<br>スタイル：btn-secondary |
| 23 | チェックボックス | 削除済み表示 | checkbox | 任意 | 論理削除された商品を表示<br>デフォルト：OFF |

### 3.5 一括操作パネル

| No | 要素種別 | 項目名 | 入力形式 | 必須/任意 | 備考 |
|----|----------|--------|----------|-----------|------|
| 24 | チェックボックス | 全選択 | checkbox | - | テーブルヘッダーに配置<br>全商品の選択/解除 |
| 25 | ドロップダウン | 一括操作 | select | - | 選択項目に対する一括操作<br>オプション：選択してください、在庫一括更新、ステータス変更、CSVエクスポート |
| 26 | ボタン | 実行ボタン | button | - | 一括操作を実行<br>スタイル：btn-warning |

### 3.6 商品一覧テーブル（拡張版）

| No | 要素種別 | 項目名 | 入力形式 | 必須/任意 | 備考 |
|----|----------|--------|----------|-----------|------|
| 27 | テーブルヘッダー | 選択 | checkbox | - | 幅：5%<br>一括操作用チェックボックス |
| 28 | テーブルヘッダー | 商品ID | - | - | 幅：10%<br>ソート可能 |
| 29 | テーブルヘッダー | 商品名 | - | - | 幅：18%<br>ソート可能 |
| 30 | テーブルヘッダー | カテゴリ | - | - | 幅：12%<br>ソート可能 |
| 31 | テーブルヘッダー | 価格 | - | - | 幅：10%<br>ソート可能 |
| 32 | テーブルヘッダー | 在庫数 | - | - | 幅：10%<br>ソート可能 |
| 33 | テーブルヘッダー | ステータス | - | - | 幅：10%<br>ソート可能 |
| 34 | テーブルヘッダー | 更新日 | - | - | 幅：10%<br>ソート可能 |
| 35 | テーブルヘッダー | 操作 | - | - | 幅：15% |
| 36 | テーブルセル | 選択チェックボックス | checkbox | - | 各行に配置 |
| 37 | テーブルセル | 商品ID表示 | code | - | `<code>`タグで表示<br>クリックでコピー可能 |
| 38 | テーブルセル | 商品名表示 | text/link | - | 通常テキスト<br>クリックで商品詳細へ |
| 39 | テーブルセル | カテゴリ表示 | badge | - | Badgeで表示<br>Electronics：bg-primary<br>Clothing：bg-info<br>Home Appliances：bg-secondary |
| 40 | テーブルセル | 価格表示 | text | - | ¥表記<br>整数表示 |
| 41 | テーブルセル | 在庫数表示 | text/link | - | 在庫状態に応じた表示<br>クリックで在庫編集モーダル起動 |
| 42 | テーブルセル | ステータス表示 | badge | - | 販売中：badge-status-active<br>販売停止：badge-status-inactive<br>削除済み：badge-status-deleted |
| 43 | テーブルセル | 更新日表示 | text | - | YYYY-MM-DD HH:mm形式 |
| 44 | テーブルセル/ボタングループ | 操作ボタン | button | - | 編集・履歴・削除/復元ボタン |
| 45 | ボタン | 在庫編集 | button | - | 在庫編集モーダルを開く<br>アイコン：bi-pencil<br>スタイル：btn-sm btn-primary |
| 46 | ボタン | 履歴表示 | button | - | 在庫履歴モーダルを開く<br>アイコン：bi-clock-history<br>スタイル：btn-sm btn-info |
| 47 | ボタン | 削除/復元 | button | - | 商品を論理削除/復元<br>アイコン：bi-trash / bi-arrow-counterclockwise<br>スタイル：btn-sm btn-danger / btn-success |

### 3.7 ページネーション

| No | 要素種別 | 項目名 | 入力形式 | 必須/任意 | 備考 |
|----|----------|--------|----------|-----------|------|
| 48 | セレクトボックス | 表示件数 | select | - | オプション：20件、50件、100件<br>デフォルト：20件 |
| 49 | リンク | 最初のページ | link | - | 最初のページへ遷移<br>アイコン：bi-chevron-double-left |
| 50 | リンク | 前のページ | link | - | 前のページへ遷移<br>アイコン：bi-chevron-left |
| 51 | リンク | ページ番号 | link | - | 各ページへ遷移<br>現在ページは「active」クラス |
| 52 | リンク | 次のページ | link | - | 次のページへ遷移<br>アイコン：bi-chevron-right |
| 53 | リンク | 最後のページ | link | - | 最後のページへ遷移<br>アイコン：bi-chevron-double-right |
| 54 | テキスト | ページ情報 | text | - | 「全X件中 Y-Z件を表示 (ページ N/M)」 |

### 3.8 在庫編集モーダル

| No | 要素種別 | 項目名 | 入力形式 | 必須/任意 | 備考 |
|----|----------|--------|----------|-----------|------|
| 55 | モーダルヘッダー | タイトル | - | - | 「在庫編集」<br>商品名・IDを表示 |
| 56 | テキスト表示 | 現在の在庫数 | text | - | 大きく表示<br>在庫状態に応じた色分け |
| 57 | ラジオボタン | 操作選択：入庫 | radio | 必須 | name：stockOperation<br>value：in<br>デフォルト：選択済み |
| 58 | ラジオボタン | 操作選択：出庫 | radio | 必須 | name：stockOperation<br>value：out |
| 59 | ラジオボタン | 操作選択：在庫数設定 | radio | 必須 | name：stockOperation<br>value：set<br>在庫数を直接設定 |
| 60 | 入力欄 | 数量入力 | number | 必須 | プレースホルダー：「数量を入力」<br>数値のみ入力可能 |
| 61 | 入力欄 | 備考 | textarea | 任意 | プレースホルダー：「入出庫の理由を入力（任意）」<br>最大255文字 |
| 62 | テキスト表示 | 更新後在庫数（予測） | text | - | リアルタイム計算表示 |
| 63 | ボタン | 更新ボタン | submit | - | 在庫更新処理を実行<br>スタイル：btn-primary |
| 64 | ボタン | キャンセルボタン | button | - | モーダルを閉じる<br>スタイル：btn-secondary |

### 3.9 在庫履歴モーダル

| No | 要素種別 | 項目名 | 入力形式 | 必須/任意 | 備考 |
|----|----------|--------|----------|-----------|------|
| 65 | モーダルヘッダー | タイトル | - | - | 「在庫変動履歴」<br>商品名・IDを表示 |
| 66 | セレクトボックス | 期間フィルタ | select | 任意 | オプション：全期間、今日、過去7日間、過去30日間、過去90日間、カスタム |
| 67 | テーブル | 履歴一覧 | table | - | 取引日時、種別、数量、変更前、変更後、実行者、備考を表示 |
| 68 | ボタン | CSVエクスポート | button | - | 履歴をCSV出力<br>スタイル：btn-sm btn-outline-primary |
| 69 | ボタン | 閉じるボタン | button | - | モーダルを閉じる<br>スタイル：btn-secondary |

### 3.10 在庫アラート閾値設定モーダル

| No | 要素種別 | 項目名 | 入力形式 | 必須/任意 | 備考 |
|----|----------|--------|----------|-----------|------|
| 70 | モーダルヘッダー | タイトル | - | - | 「在庫アラート閾値設定」 |
| 71 | 入力欄 | 在庫不足閾値 | number | 必須 | プレースホルダー：「20」<br>デフォルト：20個<br>この値以下で警告表示 |
| 72 | 入力欄 | 在庫切れ閾値 | number | 必須 | プレースホルダー：「0」<br>デフォルト：0個<br>この値でエラー表示 |
| 73 | テキスト | 説明 | text | - | 設定の説明文 |
| 74 | ボタン | 保存ボタン | submit | - | 閾値を保存<br>スタイル：btn-primary |
| 75 | ボタン | キャンセルボタン | button | - | モーダルを閉じる<br>スタイル：btn-secondary |

### 3.11 一括在庫更新モーダル

| No | 要素種別 | 項目名 | 入力形式 | 必須/任意 | 備考 |
|----|----------|--------|----------|-----------|------|
| 76 | モーダルヘッダー | タイトル | - | - | 「一括在庫更新」<br>選択商品数を表示 |
| 77 | テーブル | 選択商品一覧 | table | - | 商品ID、商品名、現在の在庫数を表示 |
| 78 | ラジオボタン | 操作種別：入庫 | radio | 必須 | 全商品に対して入庫 |
| 79 | ラジオボタン | 操作種別：出庫 | radio | 必須 | 全商品に対して出庫 |
| 80 | 入力欄 | 数量 | number | 必須 | 全商品に適用する数量 |
| 81 | 入力欄 | 備考 | textarea | 任意 | 一括更新の理由 |
| 82 | ボタン | 実行ボタン | submit | - | 一括更新を実行<br>スタイル：btn-warning |
| 83 | ボタン | キャンセルボタン | button | - | モーダルを閉じる<br>スタイル：btn-secondary |

---

## 4. 機能仕様

### 4.1 画面表示機能

#### 4.1.1 在庫一覧表示（拡張版）
- **処理概要**：全商品の在庫情報を管理者向けに詳細表示
- **表示項目**：選択チェックボックス、商品ID、商品名、カテゴリ、価格、在庫数、ステータス、更新日時、操作ボタン
- **表示順**：デフォルトは商品名昇順、カラムクリックでソート可能
- **ページング**：1ページあたり20件/50件/100件から選択可能
- **削除済み商品**：チェックボックスONで表示可能
- **在庫数表示ルール**：
  - 0個：在庫切れ（赤色、アイコン付き）
  - 1-20個：在庫不足（黄色、アイコン付き）
  - 21個以上：在庫十分（通常表示）

#### 4.1.2 在庫不足アラート表示（拡張版）
- **表示条件**：設定した閾値以下の商品が存在する場合
- **表示内容**：
  - 在庫不足商品数
  - 在庫切れ商品数
  - 閾値設定リンク
- **スタイル**：alert-warning（黄色背景）
- **アイコン**：bi-exclamation-triangle-fill
- **閾値変更**：リンクをクリックして閾値設定モーダルを開く

### 4.2 検索・フィルタリング機能（拡張版）

#### 4.2.1 商品名・ID検索
- **検索方式**：部分一致検索
- **対象項目**：商品名、商品ID
- **大文字小文字**：区別しない
- **動作**：検索ボタン押下時に実行

#### 4.2.2 カテゴリフィルタ
- **選択肢**：全て、Electronics、Clothing、Home Appliances
- **動作**：選択したカテゴリの商品のみ表示
- **デフォルト**：全て

#### 4.2.3 ステータスフィルタ（拡張版）
- **選択肢**：全て、販売中(active)、販売停止(inactive)、削除済み(deleted)
- **動作**：選択したステータスの商品のみ表示
- **デフォルト**：全て
- **削除済み商品**：チェックボックスONで表示可能

#### 4.2.4 在庫状態フィルタ
- **選択肢**：全て、在庫あり(21個以上)、在庫不足(1-20個)、在庫なし(0個)
- **動作**：選択した在庫状態の商品のみ表示
- **デフォルト**：全て

#### 4.2.5 並び順（拡張版）
- **選択肢**：
  - 商品名順：name（昇順）
  - 在庫数順（昇順）：stock_asc
  - 在庫数順（降順）：stock_desc
  - 更新日順：updated（降順）
- **デフォルト**：商品名順
- **ソート機能**：テーブルヘッダークリックでソート切替可能

#### 4.2.6 範囲検索
- **価格範囲**：最小価格〜最大価格で検索
- **在庫数範囲**：最小在庫数〜最大在庫数で検索
- **動作**：両方の値が入力された場合のみ適用

#### 4.2.7 クリア機能
- **動作**：全ての検索・フィルタ条件をリセット
- **実行方法**：クリアボタン押下

### 4.3 在庫編集機能

#### 4.3.1 個別在庫編集
- **起動方法**：
  - テーブル内の在庫数をクリック
  - 操作列の「在庫編集」ボタンをクリック
- **モーダル表示内容**：
  - 商品情報（ID、名前）
  - 現在の在庫数（大きく表示）
  - 操作選択（入庫/出庫/在庫数設定）
  - 数量入力欄
  - 備考入力欄（任意）
  - 更新後在庫数の予測表示

#### 4.3.2 入庫処理
- **処理概要**：現在の在庫数に入力値を加算
- **計算式**：新在庫数 = 現在の在庫数 + 入力値
- **制約**：入力値は正の整数のみ
- **処理後**：
  - 在庫数を更新
  - 更新日時を現在日時に更新
  - stock_transactionsテーブルに入庫記録を追加（実行者ID、備考含む）
  - モーダルを閉じて一覧画面をリフレッシュ

#### 4.3.3 出庫処理
- **処理概要**：現在の在庫数から入力値を減算
- **計算式**：新在庫数 = 現在の在庫数 - 入力値
- **制約**：
  - 入力値は正の整数のみ
  - 新在庫数が負にならないこと
- **処理後**：
  - 在庫数を更新
  - 更新日時を現在日時に更新
  - stock_transactionsテーブルに出庫記録を追加
  - モーダルを閉じて一覧画面をリフレッシュ

#### 4.3.4 在庫数設定処理
- **処理概要**：在庫数を入力値で上書き
- **計算式**：新在庫数 = 入力値
- **制約**：入力値は0以上の整数
- **処理後**：
  - 在庫数を更新
  - 更新日時を現在日時に更新
  - stock_transactionsテーブルに設定記録を追加（操作種別：set）
  - モーダルを閉じて一覧画面をリフレッシュ

### 4.4 一括操作機能

#### 4.4.1 商品選択
- **選択方法**：
  - 各行のチェックボックスをクリック
  - テーブルヘッダーの「全選択」チェックボックスで一括選択/解除
- **選択状態**：選択された行はハイライト表示

#### 4.4.2 一括在庫更新
- **実行手順**：
  1. 更新したい商品を選択
  2. 一括操作ドロップダウンから「在庫一括更新」を選択
  3. 実行ボタンをクリック
  4. 一括在庫更新モーダルが表示
  5. 操作種別（入庫/出庫）と数量を入力
  6. 実行ボタンで確定
- **処理内容**：選択した全商品に対して同じ操作を実行
- **注意事項**：出庫時は各商品の在庫数を超えないようチェック

#### 4.4.3 一括ステータス変更
- **実行手順**：
  1. 変更したい商品を選択
  2. 一括操作ドロップダウンから「ステータス変更」を選択
  3. 変更後のステータスを選択
  4. 実行ボタンで確定
- **処理内容**：選択した全商品のステータスを一括変更

#### 4.4.4 一括CSVエクスポート
- **実行手順**：
  1. エクスポートしたい商品を選択
  2. 一括操作ドロップダウンから「CSVエクスポート」を選択
  3. 実行ボタンをクリック
- **処理内容**：選択した商品のデータをCSV形式でダウンロード

### 4.5 CSV機能

#### 4.5.1 CSV一括インポート
- **遷移先**：/admin/inventory/import
- **処理概要**：CSVファイルから在庫データを一括更新
- **ファイル形式**：
  - 文字コード：UTF-8
  - 列：商品ID、在庫数、備考（オプション）
- **バリデーション**：
  - 商品IDの存在チェック
  - 在庫数は0以上の整数
  - 最大1000件まで
- **処理後**：
  - 各商品の在庫を更新
  - stock_transactionsテーブルに記録
  - 処理結果サマリーを表示

#### 4.5.2 CSVエクスポート
- **処理概要**：現在の表示条件に基づいて在庫データをCSV出力
- **ファイル名**：inventory_YYYYMMDD_HHmmss.csv
- **出力項目**：商品ID、商品名、カテゴリ、価格、在庫数、ステータス、更新日
- **文字コード**：UTF-8（BOM付き）
- **Excel対応**：カンマ区切り、ダブルクォートで囲む

### 4.6 在庫履歴表示機能

#### 4.6.1 履歴モーダル表示
- **起動方法**：操作列の「履歴」ボタンをクリック
- **表示内容**：
  - 取引日時（新しい順）
  - 取引種別（入庫/出庫/設定）
  - 数量
  - 変更前在庫数
  - 変更後在庫数
  - 実行者（ユーザー名）
  - 備考
- **期間フィルタ**：全期間、今日、過去7日間、過去30日間、過去90日間、カスタム
- **ページング**：1ページあたり20件表示

#### 4.6.2 履歴のCSVエクスポート
- **処理概要**：表示中の履歴をCSV形式でエクスポート
- **ファイル名**：stock_history_{商品ID}_{YYYYMMDD}.csv
- **出力項目**：履歴モーダルの全項目

### 4.7 在庫アラート閾値設定機能

#### 4.7.1 閾値設定
- **起動方法**：在庫不足アラート内の「閾値設定」リンクをクリック
- **設定項目**：
  - 在庫不足閾値（デフォルト：20個）
  - 在庫切れ閾値（デフォルト：0個）
- **制約**：
  - 在庫不足閾値 > 在庫切れ閾値
  - 両方とも0以上の整数
- **保存先**：システム設定テーブルまたは管理者設定
- **適用範囲**：全商品に適用

### 4.8 商品削除・復元機能

#### 4.8.1 論理削除
- **実行方法**：操作列の「削除」ボタンをクリック→確認モーダルで確定
- **処理内容**：
  - deleted_atカラムに削除日時を記録
  - ステータスをdeletedに変更
  - 通常の一覧からは非表示
- **制約**：削除済み商品は在庫操作不可

#### 4.8.2 復元
- **実行方法**：
  1. 「削除済み表示」チェックボックスをON
  2. 削除済み商品の「復元」ボタンをクリック
- **処理内容**：
  - deleted_atカラムをNULLに設定
  - ステータスをinactiveに変更
  - 通常の一覧に表示

### 4.9 在庫レポート機能

#### 4.9.1 レポート画面遷移
- **遷移先**：/admin/inventory/report
- **表示内容**：
  - 在庫総数
  - 在庫金額総額
  - カテゴリ別在庫分布
  - 在庫回転率（将来実装）
  - 在庫推移グラフ（将来実装）

### 4.10 画面遷移機能

#### 4.10.1 管理者メニューへの遷移
- **遷移方法**：
  - ナビゲーションバーのシステム名をクリック
  - ナビゲーションバーの「メニュー」をクリック
- **遷移先**：/admin/menu

#### 4.10.2 他の管理画面への遷移
- **商品管理**：/admin/products
- **ユーザー管理**：/admin/users

#### 4.10.3 ログアウト
- **実行方法**：ナビゲーションバーの「ログアウト」ボタンをクリック
- **処理**：/logoutへPOST送信
- **遷移先**：ログイン画面（/admin/login）

---

## 5. バリデーション

### 5.1 在庫編集入力バリデーション

| 項目 | バリデーション内容 |
|------|-------------------|
| 操作選択 | ・入庫、出庫、在庫数設定のいずれかを選択必須 |
| 数量入力（入庫） | ・必須入力<br>・数値のみ入力可能<br>・正の整数のみ（1以上）<br>・最大値：999,999 |
| 数量入力（出庫） | ・必須入力<br>・数値のみ入力可能<br>・正の整数のみ（1以上）<br>・現在の在庫数以下の値のみ入力可能<br>・最大値：999,999 |
| 数量入力（在庫数設定） | ・必須入力<br>・数値のみ入力可能<br>・0以上の整数<br>・最大値：999,999 |
| 備考 | ・任意入力<br>・最大文字数：255文字 |

### 5.2 一括更新バリデーション

| 項目 | バリデーション内容 |
|------|-------------------|
| 商品選択 | ・最低1商品以上選択必須<br>・最大100商品まで同時選択可能 |
| 操作種別 | ・入庫または出庫を選択必須 |
| 数量 | ・必須入力<br>・数値のみ<br>・正の整数のみ<br>・出庫の場合：全選択商品の在庫数をチェック |
| 備考 | ・任意入力<br>・最大500文字 |

### 5.3 CSVインポートバリデーション

| 項目 | バリデーション内容 |
|------|-------------------|
| ファイル形式 | ・CSV形式のみ<br>・最大ファイルサイズ：5MB |
| 文字コード | ・UTF-8のみ |
| データ件数 | ・1件以上1000件以下 |
| 商品ID | ・必須<br>・存在する商品IDのみ<br>・削除済み商品は除外 |
| 在庫数 | ・必須<br>・0以上の整数<br>・最大値：999,999 |

### 5.4 閾値設定バリデーション

| 項目 | バリデーション内容 |
|------|-------------------|
| 在庫不足閾値 | ・必須入力<br>・数値のみ<br>・0以上の整数<br>・在庫切れ閾値より大きい値 |
| 在庫切れ閾値 | ・必須入力<br>・数値のみ<br>・0以上の整数<br>・在庫不足閾値より小さい値 |

### 5.5 検索フィルタバリデーション

| 項目 | バリデーション内容 |
|------|-------------------|
| 商品名・ID検索 | ・任意入力<br>・最大文字数：100文字 |
| 価格範囲 | ・任意入力<br>・数値のみ<br>・0以上<br>・最小価格 ≤ 最大価格 |
| 在庫数範囲 | ・任意入力<br>・数値のみ<br>・0以上<br>・最小在庫数 ≤ 最大在庫数 |

### 5.6 エラーメッセージ

| エラー種別 | メッセージ内容 |
|-----------|---------------|
| 数量未入力 | 「数量を入力してください。」 |
| 数量が数値でない | 「数量は数値で入力してください。」 |
| 数量が負の値 | 「数量は正の値で入力してください。」 |
| 数量が最大値超過 | 「数量は999,999以下で入力してください。」 |
| 出庫数が在庫数超過 | 「出庫数は現在の在庫数（X個）以下で入力してください。」 |
| 商品未選択 | 「商品を1つ以上選択してください。」 |
| 選択商品数超過 | 「一度に選択できる商品は100個までです。」 |
| CSV形式エラー | 「CSVファイルの形式が正しくありません。」 |
| CSV件数超過 | 「CSVファイルの件数は1000件以下にしてください。」 |
| 商品ID不存在 | 「商品ID「{ID}」は存在しません。（行{N}）」 |
| 閾値設定エラー | 「在庫不足閾値は在庫切れ閾値より大きい値を設定してください。」 |
| 権限エラー | 「この操作を実行する権限がありません。」 |
| システムエラー | 「システムエラーが発生しました。管理者に連絡してください。」 |

---

## 6. セキュリティ

### 6.1 認証・認可

| 項目 | 対策内容 |
|------|---------|
| 認証 | ・管理者ログイン認証必須<br>・未認証ユーザーは管理者ログイン画面へリダイレクト |
| 認可 | ・管理者権限チェック<br>・一般ユーザーがアクセスした場合は403エラー |
| セッション管理 | ・Spring Securityによるセッション管理<br>・セッションタイムアウト：30分<br>・管理者専用セッション |
| CSRF対策 | ・全てのPOSTリクエストでCSRFトークン検証を実施<br>・CSV一括更新など重要な操作で二重チェック |

### 6.2 入力値検証

| 項目 | 対策内容 |
|------|---------|
| XSS対策 | ・Thymeleafのエスケープ機能を使用<br>・ユーザー入力値（備考など）を全てエスケープ処理<br>・CSVインポート時の入力値もエスケープ |
| SQLインジェクション対策 | ・PreparedStatementを使用<br>・JPAのパラメータバインディングを使用<br>・動的SQLは使用しない |
| パラメータ改ざん対策 | ・サーバーサイドでの入力値検証を実施<br>・商品ID、ユーザーIDなどの改ざんチェック<br>・権限チェック（管理者のみ実行可能） |
| ファイルアップロード対策 | ・許可する拡張子：.csvのみ<br>・最大ファイルサイズ制限：5MB<br>・ウイルススキャン（本番環境推奨） |

### 6.3 データ保護

| 項目 | 対策内容 |
|------|---------|
| 通信暗号化 | ・HTTPS通信を推奨<br>・本番環境ではHTTPSを必須とする |
| ログ記録 | ・在庫変更履歴をstock_transactionsテーブルに記録<br>・誰が（user_id）いつ（transaction_date）何を（商品ID、数量）したかを完全記録<br>・管理者操作ログを別途記録（重要な操作） |
| 監査証跡 | ・一括更新の場合も個別に履歴を記録<br>・CSV一括更新の場合はバッチIDで紐付け<br>・削除・復元操作も記録 |

### 6.4 アクセス制御

| 項目 | 対策内容 |
|------|---------|
| URL直接アクセス防止 | ・管理者権限チェックをフィルタで実施<br>・権限がない場合は403エラー |
| 画面表示制御 | ・管理者専用機能は権限チェック後に表示<br>・一般ユーザーには表示しない |
| API制限 | ・管理者APIは権限チェック必須<br>・レート制限の実装（DDoS対策） |

---

## 7. レイアウト

### 7.1 画面構成

```
+--------------------------------------------------+
| ナビゲーションバー (管理者用・固定)                  |
| [🛡️ 商品在庫管理システム 管理者]                  |
| [在庫管理*] [商品管理] [ユーザー管理] [メニュー] [ログアウト] |
+--------------------------------------------------+
| メインコンテンツエリア                              |
|   [在庫管理] ..................... [CSV一括更新] [CSVエクスポート] [レポート] |
|   +----------------------------------------------+ |
|   | 在庫不足アラート [閾値設定]                      | |
|   +----------------------------------------------+ |
|   +----------------------------------------------+ |
|   | 検索・フィルタリングパネル（拡張版）               | |
|   | [商品名・ID] [カテゴリ] [ステータス] [在庫状態]  | |
|   | [価格範囲] [在庫数範囲] [並び順]                | |
|   | [検索] [クリア] ☑削除済み表示                   | |
|   +----------------------------------------------+ |
|   +----------------------------------------------+ |
|   | 一括操作: [選択してください▼] [実行]             | |
|   +----------------------------------------------+ |
|   +----------------------------------------------+ |
|   | 商品一覧テーブル（管理者用）                     | |
|   | ☑|ID|商品名|カテゴリ|価格|在庫|ステータス|更新日|操作| |
|   | ☐|...|......|........|....|....|.........|.....|[編集][履歴][削除]| |
|   +----------------------------------------------+ |
|   +----------------------------------------------+ |
|   | 表示件数: [20件▼]                               | |
|   | ページネーション                                | |
|   | [<<] [<] [1] [2] [3] ... [>] [>>]           | |
|   +----------------------------------------------+ |
+--------------------------------------------------+
```

### 7.2 レスポンシブデザイン

- **Bootstrap 5.2.3**のグリッドシステムを使用
- **ブレークポイント**：
  - モバイル（< 768px）：縦スクロール、テーブルは横スクロール可能、一部機能は簡略表示
  - タブレット（768px - 1024px）：2カラムレイアウト、操作ボタンはアイコンのみ
  - デスクトップ（> 1024px）：フルレイアウト、全機能表示

### 7.3 カラースキーム（管理者用）

| 要素 | カラー/スタイル |
|------|---------------|
| ナビゲーションバー | navbar-custom-admin（ダークブルー系） |
| 管理者バッジ | badge admin-badge（赤系） |
| 在庫切れ（0個） | テキスト（赤色、bi-exclamation-circle-fill） |
| 在庫不足（1-20個） | テキスト（黄色、bi-exclamation-triangle-fill） |
| 在庫十分（21個以上） | 通常テキスト |
| 販売中バッジ | badge-status-active（緑系） |
| 販売停止バッジ | badge-status-inactive（グレー系） |
| 削除済みバッジ | badge-status-deleted（赤系） |
| 選択行 | 背景色ハイライト（薄い青） |
| 在庫不足アラート | alert-warning（黄色背景） |
| CSV一括更新ボタン | btn-success（緑） |
| 一括操作実行ボタン | btn-warning（黄色） |

### 7.4 アイコン使用

- **Bootstrap Icons 1.10.0**を使用
- 主要アイコン：
  - bi-shield-lock：管理者（ナビゲーションバー）
  - bi-clipboard-data：在庫管理
  - bi-upload：CSV一括更新
  - bi-download：CSVエクスポート
  - bi-graph-up：レポート
  - bi-pencil：編集
  - bi-clock-history：履歴
  - bi-trash：削除
  - bi-arrow-counterclockwise：復元
  - bi-exclamation-triangle-fill：警告
  - bi-exclamation-circle-fill：エラー

---

## 8. 使用技術

### 8.1 フロントエンド

| 技術 | バージョン | 用途 |
|------|----------|------|
| Thymeleaf | 3.x | テンプレートエンジン |
| Bootstrap | 5.2.3 | CSSフレームワーク |
| Bootstrap Icons | 1.10.0 | アイコンライブラリ |
| JavaScript | ES6+ | クライアントサイド処理 |
| jQuery | 3.x（オプション） | DOM操作・AJAX処理 |

### 8.2 バックエンド

| 技術 | バージョン | 用途 |
|------|----------|------|
| Spring Boot | 3.x | アプリケーションフレームワーク |
| Spring Security | 6.x | 認証・認可（管理者権限チェック） |
| Spring Data JPA | 3.x | データアクセス層 |
| Java | 17以上 | プログラミング言語 |
| Apache Commons CSV | 1.x | CSV処理 |

### 8.3 データベース

| 項目 | 内容 |
|------|------|
| RDBMS | PostgreSQL / MySQL / H2 |
| テーブル | products（商品マスタ）<br>stock_transactions（在庫変動履歴）<br>system_settings（システム設定・閾値） |

---

## 9. データ仕様

### 9.1 表示データ構造

#### 商品情報（products）

| 項目名 | データ型 | 説明 |
|--------|---------|------|
| product_id | VARCHAR(8) | 商品ID（主キー） |
| product_name | VARCHAR(100) | 商品名 |
| category | VARCHAR(50) | カテゴリ |
| price | INTEGER | 価格（円） |
| stock_quantity | INTEGER | 在庫数 |
| status | VARCHAR(20) | ステータス（active/inactive/deleted） |
| created_at | TIMESTAMP | 登録日時 |
| updated_at | TIMESTAMP | 更新日時 |
| deleted_at | TIMESTAMP | 削除日時（論理削除） |

#### 在庫変動履歴（stock_transactions）

| 項目名 | データ型 | 説明 |
|--------|---------|------|
| transaction_id | BIGINT | 取引ID（主キー、自動採番） |
| product_id | VARCHAR(8) | 商品ID（外部キー） |
| transaction_type | VARCHAR(10) | 取引種別（in/out/set） |
| quantity | INTEGER | 数量 |
| before_stock | INTEGER | 変更前在庫数 |
| after_stock | INTEGER | 変更後在庫数 |
| user_id | VARCHAR(50) | 実行ユーザーID |
| transaction_date | TIMESTAMP | 取引日時 |
| remarks | VARCHAR(255) | 備考 |
| batch_id | VARCHAR(50) | バッチID（一括更新時の識別用） |

#### システム設定（system_settings）

| 項目名 | データ型 | 説明 |
|--------|---------|------|
| setting_id | BIGINT | 設定ID（主キー） |
| setting_key | VARCHAR(50) | 設定キー |
| setting_value | VARCHAR(255) | 設定値 |
| description | VARCHAR(255) | 説明 |
| updated_at | TIMESTAMP | 更新日時 |
| updated_by | VARCHAR(50) | 更新者ID |

**在庫アラート閾値設定例**：
- setting_key: `stock_alert_low_threshold`, setting_value: `20`
- setting_key: `stock_alert_out_threshold`, setting_value: `0`

### 9.2 在庫状態の定義

| 状態 | 条件 | 表示スタイル | アラート |
|------|------|-------------|---------|
| 在庫切れ | stock_quantity ≤ 在庫切れ閾値 | 赤色テキスト、エラーアイコン | 重要アラート |
| 在庫不足 | 在庫切れ閾値 < stock_quantity ≤ 在庫不足閾値 | 黄色テキスト、警告アイコン | 警告アラート |
| 在庫十分 | stock_quantity > 在庫不足閾値 | 通常テキスト | アラートなし |

### 9.3 ステータスの定義

| ステータス | 値 | 説明 | 表示 |
|-----------|-----|------|------|
| 販売中 | active | 現在販売中の商品 | 通常表示 |
| 販売停止 | inactive | 販売を停止している商品 | 通常表示 |
| 削除済み | deleted | 論理削除された商品 | チェックボックスON時のみ表示 |

### 9.4 取引種別の定義

| 取引種別 | 値 | 説明 |
|---------|-----|------|
| 入庫 | in | 在庫数を増加 |
| 出庫 | out | 在庫数を減少 |
| 在庫数設定 | set | 在庫数を直接設定 |

---

## 10. 補足事項

### 10.1 パフォーマンス要件

- **ページ表示時間**：2秒以内（1000件表示時でも3秒以内）
- **検索処理時間**：3秒以内
- **在庫更新処理時間**：2秒以内（単一）、5秒以内（一括100件）
- **CSV処理時間**：10秒以内（1000件）
- **同時アクセス数**：管理者10ユーザー

### 10.2 今後の拡張案

#### フェーズ1（現在）
- 基本的な在庫表示・管理機能
- 一括編集機能
- CSV一括更新機能
- 在庫履歴表示
- 在庫アラート閾値設定

#### フェーズ2（今後の拡張）
- **在庫レポート機能の拡充**：
  - 在庫回転率の計算と表示
  - 在庫推移グラフ（時系列）
  - カテゴリ別在庫分析
  - 滞留在庫の検出
- **在庫予測機能**：
  - 過去のデータから将来の在庫を予測
  - 発注推奨数量の提案
- **自動発注機能**：
  - 在庫が一定数を下回った際に自動発注
  - 発注先管理
- **バーコード連携**：
  - バーコードスキャンによる在庫管理
  - スマートフォンアプリとの連携
- **複数倉庫対応**：
  - 複数の倉庫の在庫を一元管理
  - 倉庫間の在庫移動
- **入出庫理由のマスタ管理**：
  - 入庫・出庫の理由をプルダウンから選択
  - 理由別の統計表示
- **承認ワークフロー**：
  - 大量の在庫変動は承認必要
  - 承認履歴の記録

### 10.3 既知の制約事項

- 在庫数の上限は999,999個
- 1ページあたりの表示件数は20/50/100件から選択
- 一括選択は最大100商品まで
- CSV一括更新は最大1000件まで
- CSVファイルサイズは最大5MB
- 在庫履歴は無期限保存（将来的にアーカイブ機能を検討）

### 10.4 一般ユーザー画面との機能比較

| 機能 | 一般ユーザー | 管理者 |
|------|-------------|--------|
| 在庫一覧表示 | ○ | ○（削除済みも表示可） |
| 在庫検索・フィルタ | ○（基本） | ○（高度） |
| 個別在庫編集 | ○ | ○（在庫数設定も可） |
| 一括在庫編集 | × | ○ |
| CSV一括更新 | × | ○ |
| CSVエクスポート | × | ○ |
| 在庫履歴表示 | × | ○（詳細） |
| 在庫アラート閾値設定 | × | ○ |
| 商品削除・復元 | × | ○ |
| 在庫レポート | × | ○ |

### 10.5 関連画面

| 画面名 | URL | 関連性 |
|--------|-----|--------|
| 管理者メニュー画面 | /admin/menu | ナビゲーションバーから遷移 |
| 管理者用商品管理画面 | /admin/products | ナビゲーションバーから遷移 |
| 管理者用ユーザー管理画面 | /admin/users | ナビゲーションバーから遷移 |
| CSV一括更新画面 | /admin/inventory/import | CSV一括更新ボタンから遷移 |
| 在庫レポート画面 | /admin/inventory/report | レポートボタンから遷移 |
| 商品詳細画面 | /admin/products/{商品ID} | 商品名クリックで遷移 |
| 管理者ログイン画面 | /admin/login | ログアウト後に遷移 |

### 10.6 運用上の注意事項

#### 10.6.1 在庫管理のベストプラクティス
- 定期的に在庫数の実地棚卸を実施し、システム在庫と実在庫を照合
- 在庫変動の備考欄には必ず理由を記入（監査証跡として重要）
- 大量の在庫変動を行う場合は、事前にCSVエクスポートでバックアップを取得
- 在庫アラート閾値は商品特性に応じて適切に設定

#### 10.6.2 CSV一括更新の注意点
- CSVファイルは必ずシステムからエクスポートしたものをベースに編集
- 商品IDの変更や削除は厳禁
- 大量更新の前にテスト環境で動作確認を推奨
- 更新前に必ずバックアップを取得

#### 10.6.3 権限管理
- 管理者権限は必要最小限のユーザーにのみ付与
- 管理者アカウントは個人ごとに発行し、共有アカウントは使用しない
- 定期的に管理者の操作ログを確認

---

## 11. 変更履歴

| バージョン | 日付 | 変更内容 | 変更者 |
|----------|------|---------|--------|
| 1.0 | 2026-02-04 | 初版作成 | システム管理者 |
